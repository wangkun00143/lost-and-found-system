<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>失物招领系统</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "微软雅黑"; }
        body { background: #f5f7fa; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #0066CC; margin-bottom: 30px; }
        .nav { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-bottom: 30px; }
        .nav a { text-decoration: none; background: #0066CC; color: #fff; padding: 10px 20px; border-radius: 30px; cursor: pointer; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .form-group { margin-bottom: 20px; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { background: #0066CC; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px; }
        .btn-danger { background: #ff4d4f; }
        .result-box { width: 100%; height: 350px; border: 1px solid #ddd; border-radius: 5px; padding: 15px; overflow-y: auto; margin-top: 10px; background: #f9f9f9; font-size: 13px; line-height: 1.8; }
        .success-alert { background: #e6f7ef; color: #008000; padding: 10px; border-radius: 5px; margin: 15px 0; display: none; }
        .error-alert { background: #fde2e2; color: #ff4d4f; padding: 10px; border-radius: 5px; margin: 15px 0; display: none; }
        .sync-tip { background: #e6f4ff; color: #0066CC; padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: center; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>公网版失物招领系统（无需同一WiFi）</h1>
        <div class="sync-tip">✅ 公网地址：待部署后替换为你的公网域名</div>

        <!-- 导航栏 -->
        <div class="nav">
            <a onclick="switchTab('tab1')">单条添加</a>
            <a onclick="switchTab('tab2')">Excel导入</a>
            <a onclick="switchTab('tab3')">全网查询</a>
            <a onclick="switchTab('tab4')">信息匹配</a>
            <a onclick="switchTab('tab5')">数据下载</a>
            <a onclick="switchTab('tab6')">信息删除</a>
        </div>

        <!-- 1.单条添加 -->
        <div id="tab1" class="tab-content active">
            <div class="success-alert" id="tab1Success">✅ 添加成功！公网同步</div>
            <div class="form-group">
                <div style="display: flex; gap:25px;">
                    <label><input type="radio" name="infoType" value="lost" checked> 失物</label>
                    <label><input type="radio" name="infoType" value="found"> 招领</label>
                </div>
            </div>
            <div class="form-group">
                <label>物品描述【必填】</label>
                <input id="descInput" placeholder="例：黑色华为Mate60手机">
            </div>
            <button class="btn" onclick="addSingleInfo()">确认添加</button>
        </div>

        <!-- 2.Excel导入 -->
        <div id="tab2" class="tab-content">
            <div class="success-alert" id="tab2Success">✅ 导入成功！</div>
            <input type="file" id="excelFile" accept=".xlsx,.xls">
            <button class="btn" onclick="importExcel()">批量导入</button>
        </div>

        <!-- 3.全网查询 -->
        <div id="tab3" class="tab-content">
            <button class="btn" onclick="searchAllData()">全网搜索</button>
            <div class="result-box" id="searchResult">点击搜索查看所有信息</div>
        </div>

        <!-- 4.信息匹配 -->
        <div id="tab4" class="tab-content">
            <button class="btn" onclick="matchData()">全网匹配</button>
            <div class="result-box" id="matchResult">点击匹配查看结果</div>
        </div>

        <!-- 5.数据下载 -->
        <div id="tab5" class="tab-content">
            <button class="btn" onclick="downloadData('lost')">下载失物信息</button>
            <button class="btn" onclick="downloadData('found')">下载招领信息</button>
        </div>

        <!-- 6.信息删除 -->
        <div id="tab6" class="tab-content">
            <div class="success-alert" id="tab6Success">✅ 删除成功！</div>
            <input id="delIdInput" placeholder="输入ID">
            <button class="btn btn-danger" onclick="deleteSingleData()">删除</button>
        </div>
    </div>

    <script>
        // 待部署后，替换为你的公网后端域名（例：https://your-server.onrender.com）
        const BASE_URL = "https://your-server.onrender.com";
        let GLOBAL_DATA = { lost: [], found: [], match: [] };

        // 实时同步
        initData();
        setInterval(initData, 1000);

        async function initData() {
            try {
                const res = await fetch(`${BASE_URL}/api/getAllData`);
                const resData = await res.json();
                if (resData.code === 200) GLOBAL_DATA = resData.data;
            } catch (err) { console.error("同步失败：", err); }
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        // 1.单条添加
        async function addSingleInfo() {
            const desc = document.getElementById('descInput').value.trim();
            if (!desc) { alert("描述必填"); return; }
            const type = document.querySelector('input[name="infoType"]:checked').value;
            await fetch(`${BASE_URL}/api/addData`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type, desc })
            });
            document.getElementById('tab1Success').style.display = 'block';
            setTimeout(() => document.getElementById('tab1Success').style.display = 'none', 3000);
        }

        // 2.Excel导入
        async function importExcel() {
            const file = document.getElementById('excelFile').files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const workbook = XLSX.read(e.target.result, { type: 'array' });
                const data = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
                for (let item of data) {
                    await fetch(`${BASE_URL}/api/addData`, {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ type: 'lost', desc: item.描述 })
                    });
                }
                document.getElementById('tab2Success').style.display = 'block';
            };
            reader.readAsArrayBuffer(file);
        }

        // 3.全网查询
        function searchAllData() {
            let res = `失物信息（${GLOBAL_DATA.lost.length}条）\n`;
            GLOBAL_DATA.lost.forEach(i => res += `ID:${i.id} | 物品：${i.desc}\n`);
            res += `\n招领信息（${GLOBAL_DATA.found.length}条）\n`;
            GLOBAL_DATA.found.forEach(i => res += `ID:${i.id} | 物品：${i.desc}\n`);
            document.getElementById('searchResult').textContent = res;
        }

        // 4.信息匹配（优化算法）
        function matchData() {
            const match = [];
            GLOBAL_DATA.lost.forEach(l => GLOBAL_DATA.found.forEach(f => {
                let sim = 0;
                if (l.desc.includes(f.desc) || f.desc.includes(l.desc)) sim = 0.9;
                else {
                    const set1 = new Set(l.desc);
                    const set2 = new Set(f.desc);
                    const inter = [...set1].filter(x => set2.has(x)).length;
                    sim = inter / (set1.size + set2.size - inter);
                }
                if (sim >= 0.5) match.push({ sim: sim.toFixed(2), lost: l, found: f });
            }));
            let res = `匹配结果（${match.length}组）\n`;
            match.forEach(i => res += `相似度：${i.sim}\n失物：${i.lost.desc}\n招领：${i.found.desc}\n\n`);
            document.getElementById('matchResult').textContent = res;
        }

        // 5.数据下载
        function downloadData(type) {
            const data = type === 'lost' ? GLOBAL_DATA.lost : GLOBAL_DATA.found;
            const content = data.map(i => `ID:${i.id} | 物品：${i.desc}`).join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `${type === 'lost' ? '失物' : '招领'}信息.txt`;
            a.click();
        }

        // 6.信息删除
        async function deleteSingleData() {
            const id = document.getElementById('delIdInput').value.trim();
            await fetch(`${BASE_URL}/api/deleteSingle`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ type: 'lost', id })
            });
            document.getElementById('tab6Success').style.display = 'block';
            setTimeout(() => document.getElementById('tab6Success').style.display = 'none', 3000);
        }
    </script>
</body>
</html>
