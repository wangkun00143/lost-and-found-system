<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ ¡å›­å¤±ç‰©æ‹›é¢†ç³»ç»Ÿã€Python+Condaå…¨ç½‘äº’é€šç‰ˆã€‘</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "å¾®è½¯é›…é»‘", Arial, sans-serif; }
        body { background: #f5f7fa; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #0066CC; margin-bottom: 30px; }
        .nav { display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; margin-bottom: 30px; }
        .nav a { text-decoration: none; background: #0066CC; color: #fff; padding: 10px 20px; border-radius: 30px; cursor: pointer; transition: all 0.3s; }
        .nav a:hover { background: #004A99; transform: translateY(-2px); }
        .tab-content { display: none; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #333; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 5px; font-size: 14px; }
        input:focus { outline: none; border-color: #0066CC; }
        .btn { background: #0066CC; color: #fff; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px; }
        .btn:hover { background: #004A99; }
        .btn-danger { background: #ff4d4f; }
        .btn-danger:hover { background: #d9363e; }
        .btn-secondary { background: #666; }
        .result-box { width: 100%; height: 350px; border: 1px solid #ddd; border-radius: 5px; padding: 15px; overflow-y: auto; margin-top: 10px; background: #f9f9f9; font-size: 13px; line-height: 1.8; white-space: pre-wrap; }
        .radio-group { display: flex; gap: 25px; margin-bottom: 8px; align-items: center; }
        .radio-group label { font-weight: normal; cursor: pointer; }
        input[type="radio"] { width: auto; margin-right: 5px; }
        .success-alert { background: #e6f7ef; color: #008000; padding: 10px; border-radius: 5px; margin: 15px 0; display: none; }
        .error-alert { background: #fde2e2; color: #ff4d4f; padding: 10px; border-radius: 5px; margin: 15px 0; display: none; }
        .sync-tip { background: #e6f4ff; color: #0066CC; padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: center; font-weight: bold; }
        .green { color: #008000; font-weight: bold; }
        .red { color: #ff4d4f; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>æ ¡å›­å¤±ç‰©æ‹›é¢†ç³»ç»Ÿã€å…¨ç½‘å®æ—¶äº’é€šç‰ˆã€‘</h1>
        <div class="sync-tip">âœ… å·²ç»‘å®šä½ çš„æœåŠ¡å™¨ï¼šhttp://10.200.16.218:5000 | ç”µè„‘/æ‰‹æœº/å¹³æ¿ å®æ—¶ç§’åŒæ­¥</div>

        <!-- å¯¼èˆªæ  -->
        <div class="nav">
            <a onclick="switchTab('tab1')">å•æ¡ä¿¡æ¯æ·»åŠ </a>
            <a onclick="switchTab('tab2')">Excelæ‰¹é‡å¯¼å…¥</a>
            <a onclick="switchTab('tab3')">å…¨ç½‘ä¿¡æ¯æŸ¥è¯¢</a>
            <a onclick="switchTab('tab4')">ä¿¡æ¯åŒ¹é…æ ¸éªŒ</a>
            <a onclick="switchTab('tab5')">æ•°æ®æ–‡ä»¶ä¸‹è½½</a>
            <a onclick="switchTab('tab6')">å·²å®Œæˆä¿¡æ¯åˆ é™¤</a>
        </div>

        <!-- 1.å•æ¡æ·»åŠ  -->
        <div id="tab1" class="tab-content active">
            <div class="success-alert" id="tab1Success">âœ… æ·»åŠ æˆåŠŸï¼æ‰€æœ‰è®¾å¤‡å·²å®æ—¶åŒæ­¥</div>
            <div class="form-group">
                <div class="radio-group">
                    <label><input type="radio" name="infoType" value="lost" checked> å¤±ç‰©ä¿¡æ¯</label>
                    <label><input type="radio" name="infoType" value="found"> æ‹›é¢†ä¿¡æ¯</label>
                </div>
            </div>
            <div class="form-group">
                <label>ç‰©å“æè¿°ã€å¿…å¡«ï¼Œè¶Šè¯¦ç»†è¶Šå¥½ã€‘</label>
                <input id="descInput" placeholder="ä¾‹ï¼šé»‘è‰²åä¸ºMate60æ‰‹æœº/çº¢è‰²åŒè‚©åŒ…/æ ¡å›­å¡ï¼ˆå­¦å·123456ï¼‰">
            </div>
            <div class="form-group">
                <label>è”ç³»äºº</label>
                <input id="contactInput" placeholder="å§“å/ç­çº§/æ˜µç§°">
            </div>
            <div class="form-group">
                <label>è”ç³»æ–¹å¼ã€å»ºè®®å¡«å†™ã€‘</label>
                <input id="wayInput" placeholder="ç”µè¯/å¾®ä¿¡/QQ">
            </div>
            <div class="form-group">
                <label>ä¸¢å¤±/å­˜æ”¾ä½ç½®</label>
                <input id="placeInput" placeholder="æ•™å­¦æ¥¼Aåº§/å›¾ä¹¦é¦†3æ¥¼/é£Ÿå ‚2æ¥¼">
            </div>
            <button class="btn" onclick="addSingleInfo()">ç¡®è®¤æ·»åŠ </button>
            <button class="btn btn-secondary" onclick="clearTab1Input()">æ¸…ç©ºè¾“å…¥</button>
        </div>

        <!-- 2.Excelå¯¼å…¥ -->
        <div id="tab2" class="tab-content">
            <div class="success-alert" id="tab2Success">âœ… å¯¼å…¥æˆåŠŸï¼æ‰€æœ‰è®¾å¤‡å·²å®æ—¶åŒæ­¥</div>
            <div class="error-alert" id="tab2Error">âŒ å¯¼å…¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼</div>
            <div class="form-group">
                <div class="radio-group">
                    <label><input type="radio" name="importType" value="lost" checked> å¤±ç‰©ä¿¡æ¯</label>
                    <label><input type="radio" name="importType" value="found"> æ‹›é¢†ä¿¡æ¯</label>
                </div>
            </div>
            <div class="form-group">
                <label>é€‰æ‹©Excelæ–‡ä»¶ï¼ˆåˆ—åï¼šæè¿°/è”ç³»äºº/è”ç³»æ–¹å¼/ä½ç½®ï¼‰</label>
                <input type="file" id="excelFile" accept=".xlsx,.xls">
            </div>
            <button class="btn" onclick="importExcel()">æ‰¹é‡å¯¼å…¥</button>
            <button class="btn btn-secondary" onclick="clearExcelFile()">å–æ¶ˆé€‰æ‹©</button>
        </div>

        <!-- 3.å…¨ç½‘æŸ¥è¯¢ -->
        <div id="tab3" class="tab-content">
            <div class="form-group">
                <label>å…³é”®è¯æœç´¢ï¼ˆç‰©å“/è”ç³»äºº/ä½ç½®ï¼‰</label>
                <input id="searchInput" placeholder="ä¾‹ï¼šåä¸º/æ ¡å›­å¡/å›¾ä¹¦é¦†">
            </div>
            <button class="btn" onclick="searchAllData()">å…¨ç½‘æœç´¢</button>
            <button class="btn btn-secondary" onclick="clearSearch()">æ¸…ç©ºç»“æœ</button>
            <div class="result-box" id="searchResult">ğŸ‘‰ ç‚¹å‡»ã€Œå…¨ç½‘æœç´¢ã€æŸ¥çœ‹æ‰€æœ‰è®¾å¤‡å‘å¸ƒçš„ä¿¡æ¯</div>
        </div>

        <!-- 4.ä¿¡æ¯åŒ¹é… -->
        <div id="tab4" class="tab-content">
            <div class="error-alert" id="tab4Error">âŒ åŒ¹é…å¤±è´¥ï¼Œè¯·æ£€æŸ¥é˜ˆå€¼æˆ–æ•°æ®</div>
            <div class="form-group">
                <label>ç›¸ä¼¼åº¦é˜ˆå€¼ï¼ˆ0.5-0.95ï¼Œæ¨è0.6ï¼‰</label>
                <input type="number" id="thresholdInput" value="0.6" min="0.5" max="0.95" step="0.01">
            </div>
            <button class="btn" onclick="matchData()">å…¨ç½‘åŒ¹é…</button>
            <button class="btn btn-secondary" onclick="clearMatch()">æ¸…ç©ºç»“æœ</button>
            <div class="result-box" id="matchResult">ğŸ‘‰ ç‚¹å‡»ã€Œå…¨ç½‘åŒ¹é…ã€å¼€å§‹æ ¸éªŒ</div>
        </div>

        <!-- 5.æ•°æ®ä¸‹è½½ -->
        <div id="tab5" class="tab-content">
            <button class="btn" onclick="downloadData('lost')">ä¸‹è½½å…¨ç½‘å¤±ç‰©ä¿¡æ¯</button>
            <button class="btn" onclick="downloadData('found')">ä¸‹è½½å…¨ç½‘æ‹›é¢†ä¿¡æ¯</button>
        </div>

        <!-- 6.ä¿¡æ¯åˆ é™¤ -->
        <div id="tab6" class="tab-content">
            <div class="success-alert" id="tab6Success">âœ… åˆ é™¤æˆåŠŸï¼æ‰€æœ‰è®¾å¤‡å·²å®æ—¶åŒæ­¥</div>
            <div class="error-alert" id="tab6Error">âŒ åˆ é™¤å¤±è´¥ï¼ŒIDä¸å­˜åœ¨</div>
            <div class="form-group">
                <div class="radio-group">
                    <label><input type="radio" name="delType" value="lost" checked> å¤±ç‰©ä¿¡æ¯</label>
                    <label><input type="radio" name="delType" value="found"> æ‹›é¢†ä¿¡æ¯</label>
                </div>
            </div>
            <div class="form-group">
                <label>ç²¾å‡†å•æ¡åˆ é™¤ã€æ¨èã€‘ï¼ˆIDä»æŸ¥è¯¢é¡µå¤åˆ¶ï¼‰</label>
                <input id="delIdInput" placeholder="ä¾‹ï¼š1751234567890">
                <button class="btn btn-danger" style="margin-top:10px" onclick="deleteSingleData()">ç¡®è®¤åˆ é™¤</button>
            </div>
            <div style="margin-top:25px;border-top:1px dashed #ddd;padding-top:20px;">
                <label>æ‰¹é‡/æ¸…ç©ºåˆ é™¤ã€é«˜å±ã€‘</label>
                <div class="radio-group">
                    <label><input type="radio" name="batchType" value="clear" checked> æ¸…ç©ºå…¨éƒ¨</label>
                    <label><input type="radio" name="batchType" value="key"> å…³é”®è¯åˆ é™¤</label>
                </div>
                <input id="delKeyInput" placeholder="è¾“å…¥å…³é”®è¯ï¼ˆä¾‹ï¼šåä¸º/æ ¡å›­å¡ï¼‰" style="margin-top:8px;">
                <div class="red" style="font-size:12px;margin-top:5px;">âš ï¸ æ“ä½œä¸å¯é€†ï¼Œç¡®è®¤åå†æ‰§è¡Œï¼</div>
                <button class="btn btn-danger" style="margin-top:10px" onclick="batchDelete()">ç¡®è®¤æ“ä½œ</button>
            </div>
        </div>
    </div>

    <script>
        // ===================== å·²å›ºå®šä¸ºä½ çš„æœåŠ¡å™¨åœ°å€ï¼Œæ— éœ€ä¿®æ”¹ï¼=====================
        const BASE_URL = "http://10.200.16.218:5000";
        let GLOBAL_DATA = { lost: [], found: [], match: [] };

        // åˆå§‹åŒ–+å®æ—¶è½®è¯¢ï¼ˆæ¯1ç§’åŒæ­¥ä¸€æ¬¡ï¼Œå®ç°ç§’æ›´ï¼‰
        initData();
        setInterval(initData, 1000);

        // æ ¸å¿ƒæ–¹æ³•ï¼šè·å–åç«¯æ•°æ®
        async function initData() {
            try {
                const res = await fetch(`${BASE_URL}/api/getAllData`);
                const resData = await res.json();
                if (resData.code === 200) GLOBAL_DATA = resData.data;
            } catch (err) { console.error("æ•°æ®åŒæ­¥å¤±è´¥ï¼š", err); }
        }

        // é€šç”¨å·¥å…·æ–¹æ³•
        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelectorAll('.success-alert, .error-alert').forEach(a => a.style.display = 'none');
        }
        function removeAllSpaces(str) { return str ? str.replace(/\s+/g, '') : ''; }
        function showAlert(id, text, isSuccess = true) {
            const el = document.getElementById(id); el.textContent = text; el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 3000);
        }

        // 1.å•æ¡æ·»åŠ 
        function clearTab1Input() {
            document.getElementById('descInput').value = '';
            document.getElementById('contactInput').value = '';
            document.getElementById('wayInput').value = '';
            document.getElementById('placeInput').value = '';
        }
        async function addSingleInfo() {
            const desc = removeAllSpaces(document.getElementById('descInput').value.trim());
            if (!desc) { alert("ç‰©å“æè¿°ä¸èƒ½ä¸ºç©ºï¼"); return; }
            const type = document.querySelector('input[name="infoType"]:checked').value;
            const params = { 
                type, desc, 
                contact: removeAllSpaces(document.getElementById('contactInput').value), 
                way: removeAllSpaces(document.getElementById('wayInput').value), 
                place: removeAllSpaces(document.getElementById('placeInput').value) 
            };
            try {
                await fetch(`${BASE_URL}/api/addData`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(params) 
                });
                showAlert('tab1Success'); 
                clearTab1Input();
            } catch (err) { alert("æ·»åŠ å¤±è´¥ï¼Œè¯·é‡è¯•"); }
        }

        // 2.Excelå¯¼å…¥
        function clearExcelFile() { document.getElementById('excelFile').value = ''; }
        async function importExcel() {
            const file = document.getElementById('excelFile').files[0];
            const type = document.querySelector('input[name="importType"]:checked').value;
            if (!file) { alert("è¯·é€‰æ‹©Excelæ–‡ä»¶ï¼"); return; }
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const workbook = XLSX.read(e.target.result, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const data = XLSX.utils.sheet_to_json(sheet);
                    for (let item of data) {
                        const desc = removeAllSpaces(String(item.æè¿° || item.è¯´æ˜ || '').trim());
                        if (!desc) continue;
                        await fetch(`${BASE_URL}/api/addData`, { 
                            method: 'POST', 
                            headers: { 'Content-Type': 'application/json' }, 
                            body: JSON.stringify({ 
                                type, desc, 
                                contact: item.è”ç³»äºº || '', 
                                way: item.è”ç³»æ–¹å¼ || '', 
                                place: item.ä½ç½® || '' 
                            }) 
                        });
                    }
                    showAlert('tab2Success'); 
                    clearExcelFile();
                } catch (err) { showAlert('tab2Error', `âŒ å¯¼å…¥å¤±è´¥ï¼š${err.message}`, false); }
            };
            reader.readAsArrayBuffer(file);
        }

        // 3.å…¨ç½‘æŸ¥è¯¢
        function clearSearch() { document.getElementById('searchResult').textContent = 'ğŸ‘‰ ç‚¹å‡»ã€Œå…¨ç½‘æœç´¢ã€æŸ¥çœ‹æ‰€æœ‰è®¾å¤‡å‘å¸ƒçš„ä¿¡æ¯'; }
        function searchAllData() {
            const keyword = removeAllSpaces(document.getElementById('searchInput').value.trim()).toLowerCase();
            let res = `ğŸ” å…¨ç½‘æœç´¢å…³é”®è¯ï¼šã€${keyword || 'å…¨éƒ¨'}ã€‘\n${'-'.repeat(90)}\n`;
            let lost = GLOBAL_DATA.lost, found = GLOBAL_DATA.found;
            if (keyword) {
                lost = lost.filter(i => i.desc.includes(keyword) || i.contact.includes(keyword));
                found = found.filter(i => i.desc.includes(keyword) || i.contact.includes(keyword));
            }
            res += `ğŸ“Œ å¤±ç‰©ä¿¡æ¯ï¼ˆ${lost.length}æ¡ï¼‰\n`;
            lost.forEach((i, idx) => res += `${idx+1}. ID:${i.id} | ç‰©å“ï¼š${i.desc} | è”ç³»äººï¼š${i.contact} | ä½ç½®ï¼š${i.place}\n`);
            res += `\nğŸ“Œ æ‹›é¢†ä¿¡æ¯ï¼ˆ${found.length}æ¡ï¼‰\n`;
            found.forEach((i, idx) => res += `${idx+1}. ID:${i.id} | ç‰©å“ï¼š${i.desc} | è”ç³»äººï¼š${i.contact} | ä½ç½®ï¼š${i.place}\n`);
            document.getElementById('searchResult').textContent = res;
        }

        // 4.ä¿¡æ¯åŒ¹é…
        function clearMatch() { document.getElementById('matchResult').textContent = 'ğŸ‘‰ ç‚¹å‡»ã€Œå…¨ç½‘åŒ¹é…ã€å¼€å§‹æ ¸éªŒ'; }
        function matchData() {
            const threshold = parseFloat(document.getElementById('thresholdInput').value);
            if (isNaN(threshold) || threshold<0.5 || threshold>0.95) { 
                showAlert('tab4Error', 'âŒ é˜ˆå€¼å¿…é¡»åœ¨0.5-0.95ä¹‹é—´', false); 
                return; 
            }
            if (GLOBAL_DATA.lost.length ===0 || GLOBAL_DATA.found.length===0) { 
                showAlert('tab4Error', 'âŒ æš‚æ— æ•°æ®ï¼Œæ— æ³•åŒ¹é…', false); 
                return; 
            }
            
            const match = [];
            GLOBAL_DATA.lost.forEach(l => GLOBAL_DATA.found.forEach(f => {
                const sim = calcSimilarity(l.desc, f.desc);
                if (sim >= threshold) match.push({ sim: sim.toFixed(2), lost: l, found: f });
            }));
            match.sort((a,b) => b.sim - a.sim);
            let res = `âœ… åŒ¹é…æˆåŠŸï¼å…±æ‰¾åˆ°${match.length}ç»„ç»“æœï¼ˆé˜ˆå€¼ï¼š${threshold}ï¼‰\n${'-'.repeat(90)}\n`;
            match.forEach((i, idx) => res += `${idx+1}. ç›¸ä¼¼åº¦ï¼š${i.sim}\n   ğŸ“Œ å¤±ç‰©ï¼š${i.lost.desc}ï¼ˆ${i.lost.contact}ï¼‰\n   âœ… æ‹›é¢†ï¼š${i.found.desc}ï¼ˆ${i.found.contact}ï¼‰\n\n`);
            document.getElementById('matchResult').textContent = res;
        }
        function calcSimilarity(s1, s2) {
            const set1 = new Set(s1), set2 = new Set(s2);
            const inter = [...set1].filter(x => set2.has(x)).length;
            const union = set1.size + set2.size - inter;
            return union ===0 ? 0 : inter/union;
        }

        // 5.æ•°æ®ä¸‹è½½
        function downloadData(type) {
            const data = type === 'lost' ? GLOBAL_DATA.lost : GLOBAL_DATA.found;
            const title = type === 'lost' ? 'å…¨ç½‘å¤±ç‰©ä¿¡æ¯' : 'å…¨ç½‘æ‹›é¢†ä¿¡æ¯';
            if (data.length ===0) { alert(`æš‚æ— ${title}ï¼`); return; }
            let content = `${title}_${new Date().toLocaleDateString()}\n${'='.repeat(80)}\n`;
            data.forEach((i, idx) => content += `${idx+1}. ID:${i.id} | ç‰©å“ï¼š${i.desc} | è”ç³»äººï¼š${i.contact} | æ–¹å¼ï¼š${i.way} | ä½ç½®ï¼š${i.place}\n`);
            const blob = new Blob([content], { type: 'text/plain;utf-8' });
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = `${title}.txt`; 
            a.click();
        }

        // 6.åˆ é™¤åŠŸèƒ½
        async function deleteSingleData() {
            const id = document.getElementById('delIdInput').value.trim();
            const type = document.querySelector('input[name="delType"]:checked').value;
            if (!id) { alert("è¯·è¾“å…¥IDï¼"); return; }
            try {
                const res = await fetch(`${BASE_URL}/api/deleteSingle`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ type, id }) 
                });
                const resData = await res.json();
                resData.code ===200 ? showAlert('tab6Success') : showAlert('tab6Error', resData.msg, false);
            } catch (err) { showAlert('tab6Error', 'âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•', false); }
        }
        async function batchDelete() {
            const type = document.querySelector('input[name="delType"]:checked').value;
            const batchType = document.querySelector('input[name="batchType"]:checked').value;
            const keyword = removeAllSpaces(document.getElementById('delKeyInput').value.trim());
            if (batchType === 'key' && !keyword) { alert("è¯·è¾“å…¥å…³é”®è¯ï¼"); return; }
            if (!confirm("âš ï¸ ç¡®è®¤æ‰§è¡Œï¼Ÿæ“ä½œä¸å¯é€†ï¼")) return;
            try {
                await fetch(`${BASE_URL}/api/batchDelete`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ type, batchType, keyword }) 
                });
                showAlert('tab6Success'); 
                document.getElementById('delKeyInput').value = '';
            } catch (err) { showAlert('tab6Error', 'âŒ æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•', false); }
        }
    </script>
</body>
</html>
