# campus_network_integration.py
import requests
import json
from datetime import datetime

class CampusNetworkIntegration:
    def __init__(self, campus_api_url, auth_token):
        self.api_url = campus_api_url
        self.headers = {
            'Authorization': f'Bearer {auth_token}',
            'Content-Type': 'application/json'
        }
    
    def sync_to_campus_network(self, item_data):
        """将本地数据同步到校园网"""
        try:
            response = requests.post(
                f'{self.api_url}/lost-found/items',
                headers=self.headers,
                json=item_data,
                timeout=10
            )
            return response.status_code == 200
        except Exception as e:
            print(f"同步失败: {e}")
            return False
    
    def get_campus_data(self):
        """从校园网获取数据"""
        try:
            response = requests.get(
                f'{self.api_url}/lost-found/items',
                headers=self.headers,
                timeout=10
            )
            if response.status_code == 200:
                return response.json()
            return []
        except Exception as e:
            print(f"获取数据失败: {e}")
            return []
    
    def publish_to_campus_bulletin(self, match_result):
        """将匹配结果发布到校园公告"""
        bulletin_data = {
            'title': '失物招领匹配通知',
            'content': self.format_bulletin_content(match_result),
            'publish_time': datetime.now().isoformat(),
            'priority': 'normal'
        }
        
        try:
            response = requests.post(
                f'{self.api_url}/bulletin/publish',
                headers=self.headers,
                json=bulletin_data,
                timeout=10
            )
            return response.status_code == 200
        except Exception as e:
            print(f"公告发布失败: {e}")
            return False
    
    def format_bulletin_content(self, match_result):
        """格式化公告内容"""
        content = f"""失物招领匹配成功通知：
        
发现以下失物与招领信息高度匹配：
• 失物描述：{match_result['失物描述']}
• 招领描述：{match_result['招领描述']}
• 匹配相似度：{match_result['相似度']}
• 联系方式：{match_result['招领人联系方式']}

请相关同学尽快联系认领。
"""
        return content
